pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:latest
    command:
    - cat
    tty: true
"""
        }
    }
    stages {
        stage('Build & Push Docker Image') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                    container('kaniko') {
                        script {
                            // Create Docker config for Kaniko authentication
                            sh """
                            mkdir -p /kaniko/.docker
                            echo '{"auths":{"https://index.docker.io/v1/":{"username":"$USER","password":"$PASS"}}}' > /kaniko/.docker/config.json
                            """

                            // Build and push image using Kaniko
                            sh """
                            /kaniko/executor --dockerfile=/workspace/app/Dockerfile \
                                             --context=/workspace/app \
                                             --destination=sridevi1902/flask-app:latest
                            """
                        }
                    }
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                container('kaniko') {
                    script {
                        sh 'kubectl apply -f k8s/deployment.yaml'
                        sh 'kubectl apply -f k8s/service.yaml'
                    }
                }
            }
        }
    }
}
