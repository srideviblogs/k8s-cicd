pipeline {
  agent {
    kubernetes {
      yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: kaniko
    image: sridevi1902/kaniko:latest
    command:
    - /busybox/cat
    tty: true

  - name: kubectl
    image: bitnami/kubectl:latest
    command:
    - cat
    tty: true
"""
    }
  }

  environment {
    IMAGE_NAME = "sridevi1902/flask-app"
    IMAGE_TAG  = "latest"
  }

  stages {

    stage('Build & Push Docker Image') {
      steps {
        container('kaniko') {
          withCredentials([usernamePassword(
            credentialsId: 'dockerhub',
            usernameVariable: 'DOCKER_USER',
            passwordVariable: 'DOCKER_PASS'
          )]) {

            sh '''
            mkdir -p /kaniko/.docker

            echo "{
              \\"auths\\": {
                \\"https://index.docker.io/v1/\\": {
                  \\"username\\": \\"$DOCKER_USER\\",
                  \\"password\\": \\"$DOCKER_PASS\\"
                }
              }
            }" > /kaniko/.docker/config.json

            /kaniko/executor \
              --dockerfile=app/Dockerfile \
              --context=app \
              --destination=$IMAGE_NAME:$IMAGE_TAG \
              --verbosity=info
            '''
          }
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        container('kubectl') {
          sh '''
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          '''
        }
      }
    }
  }
}
